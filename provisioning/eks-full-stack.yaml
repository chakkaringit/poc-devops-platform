AWSTemplateFormatVersion: '2010-09-09'
Description: 'Production Stack: VPC (Public/Private) + NAT Gateway + EKS Cluster + Private Node Group'

Parameters:
  ClusterName:
    Type: String
    Description: "Name of the EKS Cluster (Passed from Jenkins)"
    # Default: "ProductionCluster"

  NodeInstanceType:
    Type: String
    Default: "t3.medium" # ปรับเป็น m5.large หรือตามต้องการสำหรับ Prod
    AllowedValues: ["t3.medium", "t3.large", "t4g.xlarge", "m5.large", "m5.xlarge", "m6a.2xlarge"]
    Description: "EC2 Instance type for worker nodes"

Resources:
  
  # ============================================================
  # 1. VPC & INTERNET GATEWAY
  # ============================================================
  EksVpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub "${ClusterName}-VPC"

  InternetGateway:
    Type: AWS::EC2::InternetGateway

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref EksVpc
      InternetGatewayId: !Ref InternetGateway

  # ============================================================
  # 2. PUBLIC SUBNETS (For NAT GW & Load Balancers)
  # ============================================================
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref EksVpc
      Tags:
        - Key: Name
          Value: !Sub "${ClusterName}-Public-RT"

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  # Public Subnet 1
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref EksVpc
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      CidrBlock: 10.0.0.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${ClusterName}-Public-1"
        - Key: !Sub "kubernetes.io/cluster/${ClusterName}"
          Value: "shared"
        - Key: "kubernetes.io/role/elb" # Tag สำหรับ Public LB
          Value: "1"

  # Public Subnet 2
  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref EksVpc
      AvailabilityZone: !Select [ 1, !GetAZs '' ]
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub "${ClusterName}-Public-2"
        - Key: !Sub "kubernetes.io/cluster/${ClusterName}"
          Value: "shared"
        - Key: "kubernetes.io/role/elb"
          Value: "1"

  PublicSubnet1Assoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2Assoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  # ============================================================
  # 3. NAT GATEWAY (The Costly Part - Required for Private Nodes)
  # ============================================================
  # สร้าง Elastic IP สำหรับ NAT
  NatGatewayEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  # สร้าง NAT Gateway ใน Public Subnet 1 (ตัวเดียวตาม config nat_gateways=1)
  NatGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet1

  # ============================================================
  # 4. PRIVATE SUBNETS (For Worker Nodes)
  # ============================================================
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref EksVpc
      Tags:
        - Key: Name
          Value: !Sub "${ClusterName}-Private-RT"

  # Route ของ Private ให้ออกเน็ตผ่าน NAT Gateway (ไม่ใช่ IGW)
  PrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  # Private Subnet 1
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref EksVpc
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      CidrBlock: 10.0.2.0/24
      MapPublicIpOnLaunch: false # ปิด Public IP
      Tags:
        - Key: Name
          Value: !Sub "${ClusterName}-Private-1"
        - Key: !Sub "kubernetes.io/cluster/${ClusterName}"
          Value: "shared"
        - Key: "kubernetes.io/role/internal-elb" # Tag สำหรับ Internal LB
          Value: "1"

  # Private Subnet 2
  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref EksVpc
      AvailabilityZone: !Select [ 1, !GetAZs '' ]
      CidrBlock: 10.0.3.0/24
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${ClusterName}-Private-2"
        - Key: !Sub "kubernetes.io/cluster/${ClusterName}"
          Value: "shared"
        - Key: "kubernetes.io/role/internal-elb"
          Value: "1"

  PrivateSubnet1Assoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet2Assoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  # ============================================================
  # 5. IAM ROLES
  # ============================================================
  EKSClusterRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ClusterName}-Cluster-Role"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: eks.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSClusterPolicy

  EKSNodeInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${ClusterName}-Node-Role"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: ec2.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
        - arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
        - arn:aws:iam::aws:policy/service-role/AmazonEFSCSIDriverPolicy

  # ============================================================
  # 6. EKS CLUSTER
  # ============================================================
  EKSCluster:
    Type: AWS::EKS::Cluster
    Properties:
      Name: !Ref ClusterName
      Version: "1.32"
      RoleArn: !GetAtt EKSClusterRole.Arn
      ResourcesVpcConfig:
        # Cluster Control Plane ควรรู้จักทุก Subnet (ทั้ง Public และ Private)
        SubnetIds:
          - !Ref PublicSubnet1
          - !Ref PublicSubnet2
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
        EndpointPublicAccess: true
        EndpointPrivateAccess: true # เปิดให้ Node ใน Private คุยกับ API ได้

  # ============================================================
  # 7. NODE GROUP (Worker Nodes in PRIVATE Subnets only)
  # ============================================================
  EKSNodeGroup:
    Type: AWS::EKS::Nodegroup
    DependsOn:
      - EKSCluster
      - NatGateway # ต้องรอให้ NAT เสร็จก่อน ไม่งั้น Node จะออกเน็ตไปดึง Image ไม่ได้
    Properties:
      ClusterName: !Ref EKSCluster
      NodeRole: !GetAtt EKSNodeInstanceRole.Arn
      # จุดสำคัญ: Worker Node รันใน Private Subnet เท่านั้น! (เหมือน CDK)
      Subnets:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      ScalingConfig:
        MinSize: 1
        MaxSize: 5 # ปรับตาม CDK (เดิม Max 3)
        DesiredSize: 2
      InstanceTypes:
        - !Ref NodeInstanceType
      AmiType: AL2_x86_64
      #AmiType: AL2_ARM_64

  # ============================================================
  # 8. EFS FILE SYSTEM (Network Storage) [NEW]
  # ============================================================
  # 1. Security Group for EFS
  EFSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Allow EKS Nodes to mount EFS"
      VpcId: !Ref EksVpc
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          CidrIp: 10.0.0.0/16 # อนุญาตทั้ง VPC

  # 2. File System
  EFSFileSystem:
    Type: AWS::EFS::FileSystem
    Properties:
      Encrypted: true
      PerformanceMode: generalPurpose
      ThroughputMode: bursting
      FileSystemTags:
        - Key: Name
          Value: !Sub "${ClusterName}-EFS"

  # 3. Mount Targets (เชื่อมกับ Private Subnet ที่ Node อยู่)
  EFSMountTarget1:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EFSFileSystem
      SubnetId: !Ref PrivateSubnet1
      SecurityGroups:
        - !Ref EFSSecurityGroup

  EFSMountTarget2:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref EFSFileSystem
      SubnetId: !Ref PrivateSubnet2
      SecurityGroups:
        - !Ref EFSSecurityGroup

  # ============================================================
  # 9. S3 BUCKETS (Input & Processed) + Bucket Policy
  # ============================================================
  
  # --- Input Bucket ---
  InputS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub "${ClusterName}-input-data"

  InputS3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref InputS3Bucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              AWS: "arn:aws:iam::288761762907:role/SduInfraStack-CustomS3AutoDeleteObjectsCustomResour-XsEQ2ZMEFHQq"
            Action:
              - "s3:DeleteObject*"
              - "s3:GetBucket*"
              - "s3:List*"
              - "s3:PutBucketPolicy"
            Resource:
              - !GetAtt InputS3Bucket.Arn
              - !Sub "${InputS3Bucket.Arn}/*"

  # --- Processed Bucket ---
  ProcessedS3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      Tags:
        - Key: Name
          Value: !Sub "${ClusterName}-processed-data"

  ProcessedS3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ProcessedS3Bucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              AWS: "arn:aws:iam::288761762907:role/SduInfraStack-CustomS3AutoDeleteObjectsCustomResour-XsEQ2ZMEFHQq"
            Action:
              - "s3:DeleteObject*"
              - "s3:GetBucket*"
              - "s3:List*"
              - "s3:PutBucketPolicy"
            Resource:
              - !GetAtt ProcessedS3Bucket.Arn
              - !Sub "${ProcessedS3Bucket.Arn}/*"
Outputs:
  ClusterName:
    Description: "The name of the EKS Cluster"
    Value: !Ref EKSCluster
  ClusterEndpoint:
    Description: "The endpoint for your EKS Kubernetes API."
    Value: !GetAtt EKSCluster.Endpoint
  CommandToConnect:
    Description: "Run this to configure kubectl"
    Value: !Sub "aws eks update-kubeconfig --name ${ClusterName} --region ${AWS::Region}"
  EFSFileSystemId:
    Description: "ID of the EFS File System (Use this in StorageClass)"
    Value: !Ref EFSFileSystem
  InputS3BucketName:
    Description: "Name of the Input S3 Bucket"
    Value: !Ref InputS3Bucket
  ProcessedS3BucketName:
    Description: "Name of the Processed S3 Bucket"
    Value: !Ref ProcessedS3Bucket
